---
import Base from "@/layouts/Base.astro";
import extractSlug from "@/lib/utils/extractSlug";
import { getEntryCTM } from "@/lib/customContentLoader.astro";
import { parseTomlToJson } from "@/lib/utils/tomlUtils";
import { getCollectionCTM } from "@/lib/customContentLoader.astro";
import BlogSingle from "@/components/BlogSingle.astro";
import Breadcrumbs from "@/components/widgets/Breadcrumbs.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils";

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const config = parseTomlToJson();
      const { blogFolder }: { blogFolder: "blog" } =
        config.settings;
      const { defaultLanguage, showDefaultLangInUrl } =
        config.settings.multilingual;

      const blogIndex = await getEntryCTM(
        blogFolder,
        "-index",
        lang.languageCode,
      );

      let blogs = await getCollectionCTM(
        blogFolder,
        lang.languageCode,
      );

      // If draft true in index.md file frontmatter don't include any page related to this page collection in production
      if (blogIndex?.data.draft && import.meta.env.PROD) {
        return [];
      }

      return blogs.map((blog) => ({
        params: {
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
          single: extractSlug(blog).split("/").pop(),
        },
        props: {
          blog,
        },
      }));
    }),
  );

  return paths.flat();
}

const { blog } = Astro.props;
---

<Base {...blog.data}>
  <Breadcrumbs breadcrumbExcludedPaths={["Blog"]} />
  <BlogSingle content={blog} />
</Base>
